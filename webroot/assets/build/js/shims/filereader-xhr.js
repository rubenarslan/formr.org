webshim.register("filereader-xhr",(function(e,t,o,a,r,n){"use strict";var i,s,l,u='input[type="file"].ws-filereader, input[type="file"].ws-capture',d=swfmini.hasFlashPlayerVersion("10.3"),p=function(){t.loader.loadList(["moxie"])},f=function(){var o,a,r,n,s=this;t.implement(s,"filepicker")&&(s=this,o=e(this),r=o.parent(),n=function(){s.value||o.prop("value","")},o.attr("tabindex","-1").on("mousedown.filereaderwaiting click.filereaderwaiting",!1),r.addClass("ws-loading"),a=new i.FileInput({browse_button:this,accept:e.prop(this,"accept"),multiple:e.prop(this,"multiple")}),o.jProp("form").on("reset",(function(){setTimeout(n)})),a.onready=function(){o.off(".fileraderwaiting"),r.removeClass("ws-waiting")},a.onchange=function(e){t.data(s,"fileList",e.target.files),o.trigger("change")},a.onmouseenter=function(){o.trigger("mouseover"),r.addClass("ws-mouseenter")},a.onmouseleave=function(){o.trigger("mouseout"),r.removeClass("ws-mouseenter")},a.onmousedown=function(){o.trigger("mousedown"),r.addClass("ws-active")},a.onmouseup=function(){o.trigger("mouseup"),r.removeClass("ws-active")},t.data(s,"filePicker",a),t.ready("WINDOWLOAD",(function(){var e;o.onWSOff("updateshadowdom",(function(){var t=s.offsetWidth;t&&e!=t&&(e=t,a.refresh())}))})),t.addShadowDom(),a.init(),s.disabled&&a.disable(!0))},c=function(e){return e.name},m=function(){var o=this;p(),e(o).on("mousedown.filereaderwaiting click.filereaderwaiting",!1).parent().addClass("ws-loading"),t.ready("moxie",(function(){m.call(o)}))},h=/^(?:script|jsonp)$/i,y=function(){p(),t.error('filereader/formdata not ready yet. please wait for moxie to load `webshim.ready("moxie", callbackFn);`` or wait for the first change event on input[type="file"].ws-filereader.')},g=t.defineNodeNameProperty("input","value",{prop:{get:function(){var e=t.data(this,"fileList");return e&&e.map?e.map(c).join(", "):g.prop._supget.call(this)}}}),w=t.cfg.basePath+"moxie/",x='You nedd a crossdomain.xml to get all "filereader" / "XHR2" / "CORS" features to work. Or host moxie.swf on your server an configure filereader options: "swfpath"',v=function(t){return"moxie"==t.wsType||t.data&&t.data instanceof i.FormData||t.crossDomain&&!1!==e.support.cors&&"no"!=l&&!h.test(t.dataType||"")},b=function(o){var a;if(v(o))return t.info("moxie transfer used for $.ajax"),"no"==l&&t.error(x),{send:function(t,r){var i=function(e,t){if(o[t]){var r=!1;a.addEventListener("load",(function(){r?r.lengthComputable&&r.total>r.loaded&&o[t]({type:"progress",lengthComputable:!0,total:r.total,loaded:r.total}):o[t]({type:"progress",lengthComputable:!0,total:1,loaded:1})})),e.addEventListener("progress",(function(e){r=e,o[t](e)}))}};(a=new s.xhr.XMLHttpRequest).open(o.type,o.url,o.async,o.username,o.password),i(a.upload,n.uploadprogress),i(a.upload,n.progress),a.addEventListener("load",(function(){var e={text:a.responseText,xml:a.responseXML};r(a.status,a.statusText,e,a.getAllResponseHeaders())})),o.xhrFields&&o.xhrFields.withCredentials&&(a.withCredentials=!0),o.timeout&&(a.timeout=o.timeout),e.each(t,(function(e,t){a.setRequestHeader(e,t)})),a.send(o.data)},abort:function(){a&&a.abort()}}},L={xdomain:function(){var o=/^https?:\/\//i,a=/^get|post$/i,r=new RegExp("^"+location.protocol,"i");return function(n,s){if(!(!n.crossDomain||n.username||n.xhrFields&&n.xhrFields.withCredentials||!n.async||!a.test(n.type)||!o.test(n.url)||!r.test(n.url)||n.data&&n.data instanceof i.FormData||h.test(n.dataType||""))){var l=null;return t.info("xdomain transport used."),{send:function(t,o){var a="",r=(s.dataType||"").toLowerCase();l=new XDomainRequest,/^\d+$/.test(s.timeout)&&(l.timeout=s.timeout),l.ontimeout=function(){o(500,"timeout")},l.onload=function(){var t="Content-Length: "+l.responseText.length+"\r\nContent-Type: "+l.contentType,a={code:l.status||200,message:l.statusText||"OK"},n={text:l.responseText,xml:l.responseXML};try{if("html"===r||/text\/html/i.test(l.contentType))n.html=l.responseText;else if("json"===r||"text"!==r&&/\/json/i.test(l.contentType))try{n.json=e.parseJSON(l.responseText)}catch(e){}else if("xml"===r&&!l.responseXML){var i;try{(i=new ActiveXObject("Microsoft.XMLDOM")).async=!1,i.loadXML(l.responseText)}catch(e){}n.xml=i}}catch(e){}o(a.code,a.message,n,t)},l.onprogress=function(){},l.onerror=function(){o(500,"error",{text:l.responseText})},s.data&&(a="string"===e.type(s.data)?s.data:e.param(s.data)),l.open(n.type,n.url),l.send(a)},abort:function(){l&&l.abort()}}}}}(),moxie:function(e,o,a){if(v(e)){p();var r,n={send:function(o,a){r=!0,t.ready("moxie",(function(){r&&(r=b(e),n.send=r.send,n.abort=r.abort,r.send(o,a))}))},abort:function(){r=!1}};return n}}};t.loader.addModule("moxie",{src:"moxie/js/moxie-"+(d?"swf":"html4")}),n.progress||(n.progress="onprogress"),n.uploadprogress||(n.uploadprogress="onuploadprogress"),n.swfpath||(n.swfpath=w+"flash/Moxie.min.swf"),!1===e.support.cors&&o.XDomainRequest||delete L.xdomain,e.ajaxTransport("+*",(function(e,t,o){var a,r;if((e.wsType||L[L])&&(a=L[L](e,t,o)),!a)for(r in L)if(a=L[r](e,t,o))break;return a})),t.defineNodeNameProperty("input","files",{prop:{writeable:!1,get:function(){return"file"!=this.type?null:(e(this).is(".ws-filereader, .ws-capture")||t.info("please add the 'ws-filereader'/'ws-capture' class to your input[type='file'] to implement files-property"),t.data(this,"fileList")||[])}}}),t.reflectProperties(["input"],["accept"]),null==e("<input />").prop("multiple")&&t.defineNodeNamesBooleanProperty(["input"],["multiple"]),t.onNodeNamesPropertyModify("input","disabled",(function(e,o){var a=t.data(this,"filePicker");a&&a.disable(o)})),t.onNodeNamesPropertyModify("input","value",(function(o){""===o&&"file"==this.type&&e(this).is(".ws-filereader, .ws-capture")&&t.data(this,"fileList",[])})),a.createElement("canvas").toBlob||(t.defineNodeNameProperty("canvas","toBlob",{prop:{value:function(o,a,r){var n,s=e(this);a||(a="image/jpeg"),"image/jpeg"!=a||r||(r=.8),p(),t.ready("moxie",(function(){var e=new i.Image;n=s.callProp("getAsDataURL",[a,r]),e.onload=function(){var a=e.getAsBlob();t.defineProperty(a,"_wsDataURL",{value:n,enumerable:!1}),o(a)},e.load(n)}))}}}),t.ready("url",(function(){var e=URL.createObjectURL,t=URL.revokeObjectURL;URL.createObjectURL=function(t){var o=t;if(t._wsimgDataURL)o=t._wsimgDataURL;else if(e)return e.apply(this,arguments);return o},URL.revokeObjectURL=function(){return t?t.apply(this,arguments):void 0}}))),o.FileReader=y,o.FormData=y,t.ready("moxie",(function(){var a="application/xml,xml";s=o.moxie,(i=o.mOxie).Env.swf_url=n.swfpath,o.FileReader=i.FileReader,o.FormData=function(o){var a,r,n,s,l,u,d=new i.FormData;if(o&&e.nodeName(o,"form")){for(a=e(o).serializeArray(),r=0;r<a.length;r++)Array.isArray(a[r].value)?a[r].value.forEach((function(e){d.append(a[r].name,e)})):d.append(a[r].name,a[r].value);for(a=o.querySelectorAll('input[type="file"][name]'),r=0,a.length;r<a.length;r++)if((u=a[r].name)&&!e(a[r]).is(":disabled")&&(n=e.prop(a[r],"files")||[]).length)for((n.length>1||d.hasBlob&&d.hasBlob())&&t.error("FormData shim can only handle one file per ajax. Use multiple ajax request. One per file."),s=0,l=n.length;l>s;s++)d.append(u,n[s])}return d},m=f,L.moxie=b,n.mimeTypes=n.mimeTypes?a+","+n.mimeTypes:a;try{i.Mime.addMimeType(n.mimeTypes)}catch(e){t.warn("mimetype to moxie error: "+e)}})),t.addReady((function(t,o){e(t.querySelectorAll(u)).add(o.filter(u)).each(m)})),t.ready("WINDOWLOAD",p),!1!==t.cfg.debug&&n.swfpath.indexOf(location.protocol+"//"+location.hostname)&&n.swfpath.indexOf("https://"+location.hostname)&&t.ready("WINDOWLOAD",(function(){var o=function(){"no"==l&&t.error(x)};try{l=sessionStorage.getItem("wsXdomain.xml")}catch(e){}if(o(),null==l)try{e.ajax({url:"crossdomain.xml",type:"HEAD",dataType:"xml",success:function(){l="yes"},error:function(){l="no"},complete:function(){try{sessionStorage.setItem("wsXdomain.xml",l)}catch(e){}o()}})}catch(e){}})),"complete"==a.readyState&&webshims.isReady("WINDOWLOAD",!0)}));